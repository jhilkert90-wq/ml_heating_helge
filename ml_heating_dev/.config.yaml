name: "ML Heating Control (Dev)"
version: "0.2.0-dev"
image: "ghcr.io/helgeerbe/ml_heating:dev"
slug: "ml_heating_dev"
description: "Physics-based machine learning heating control system with online learning (Development Channel)"
url: "https://github.com/helgeerbe/ml_heating"
arch:
  - aarch64
  - amd64
startup: services
init: false
map:
  - addon_config:rw
ingress: true
ingress_port: 3001
panel_icon: mdi:heat-pump
panel_title: "ML Heating"
homeassistant: 2024.1.0
privileged:
  - SYS_RAWIO
apparmor: false
hassio_api: true
homeassistant_api: true
options:
  # Core Entity Configuration - Home Assistant Entity IDs
  # An input_number or sensor that holds the desired target indoor temperature
  target_indoor_temp_entity: "input_number.hp_auto_correct_target"
  # The primary indoor temperature sensor that the system will try to maintain
  indoor_temp_entity: "sensor.thermometer_wohnzimmer_kompensiert"
  # The outdoor temperature sensor, preferably compensated or located near the heat pump
  outdoor_temp_entity: "sensor.thermometer_waermepume_kompensiert"
  # The climate entity for your heating system, used to check if it's in 'heat' or 'auto' mode
  heating_control_entity: "climate.heizung_2"
  # The heat pump's actual outlet temperature sensor
  outlet_temp_entity: "sensor.hp_outlet_temp"
  # The entity this script will write its calculated target outlet temperature to
  target_outlet_temp_entity: "sensor.ml_vorlauftemperatur"
  # The target outlet temperature that was actually set (by model or heat curve)
  actual_target_outlet_temp_entity: "sensor.hp_target_temp_circuit1"
  # An external weather forecast temperature sensor (e.g., from OpenWeatherMap)
  openweathermap_temp_entity: "sensor.openweathermap_temperature"
  # A sensor that provides the average temperature of rooms not affected by the fireplace
  avg_other_rooms_temp_entity: "sensor.avg_other_rooms_temp"
  # The Home Assistant sensor that provides today's PV forecast with attributes
  pv_forecast_entity: "sensor.energy_production_today_4"
  
  # External Heat Sources - Entity IDs for learning external heat contributions
  # A single aggregated sensor for total PV power generation
  pv_power_entity: "sensor.power_pv"
  # A binary_sensor that is 'on' when the fireplace is active
  fireplace_status_entity: "binary_sensor.fireplace_active"
  # A sensor or input_boolean that indicates if a TV or other significant internal heat source is on
  tv_power_entity: "input_boolean.fernseher"
  
  # Blocking Detection - Entity IDs for system status monitoring
  # A binary_sensor that is 'on' when Domestic Hot Water (DHW) is being heated
  dhw_status_entity: "binary_sensor.hp_dhw_heating_status"
  # A binary_sensor that is 'on' during a defrost cycle of the heat pump
  defrost_status_entity: "binary_sensor.hp_defrosting_status"
  # A binary_sensor that is 'on' during a DHW tank disinfection cycle
  disinfection_status_entity: "binary_sensor.hp_dhw_tank_disinfection_status"
  # A binary_sensor that is 'on' when the DHW boost heater is active
  dhw_boost_heater_entity: "binary_sensor.hp_dhw_boost_heater_status"
  
  # ML Learning Parameters - Numeric configuration for model behavior
  # The time in minutes between each full cycle of learning and prediction
  cycle_interval_minutes: 30
  # The maximum allowable change (in degrees Celsius) for the heat pump's outlet temperature setpoint in a single cycle
  max_temp_change_per_cycle: 5.0
  # Number of historical steps to use as features for the model
  history_steps: 6
  # The duration of each historical step in minutes
  history_step_minutes: 10
  # The number of hours of historical data to use for initial training
  training_lookback_hours: 576
  
  # Safety Configuration - Temperature limits and safety bounds
  # The maximum safe indoor temperature allowed by the system
  safety_max_temp: 25.0
  # The minimum safe indoor temperature allowed by the system
  safety_min_temp: 18.0
  # Absolute minimum allowed outlet temperature (in °C)
  clamp_min_abs: 14.0
  # Absolute maximum allowed outlet temperature (in °C)
  clamp_max_abs: 65.0
  
  # InfluxDB Configuration - Database connection settings
  # URL of your InfluxDB instance, including the protocol and port
  influxdb_host: "a0d7b954-influxdb"
  # Port of your InfluxDB instance
  influxdb_port: 8086
  # The InfluxDB database where your Home Assistant data is stored
  influxdb_database: "homeassistant"
  # An InfluxDB API token with read access to the specified bucket
  influxdb_token: ""
  # The InfluxDB organization your Home Assistant data belongs to
  influxdb_org: "erbehome"
  # The InfluxDB bucket where your Home Assistant data is stored
  influxdb_bucket: "home_assistant/autogen"
  # InfluxDB bucket for exporting feature importances and ML metrics
  influx_features_bucket: "ml_heating_features"
  
  # Model Management - Backup and maintenance settings
  # Enable automatic model backups before updates
  auto_backup_enabled: true
  # Number of days to retain model backups
  backup_retention_days: 30
  
  # Dashboard Configuration - Web interface settings
  # Interval in seconds for dashboard data updates
  dashboard_update_interval: 30
  # Display advanced performance metrics on the dashboard
  show_advanced_metrics: true
  # Theme for the dashboard (auto, light, or dark)
  dashboard_theme: "auto"
  
  # Development Settings - Debug and development features
  # Whether to enable the development API for external access (e.g., Jupyter notebooks)
  enable_dev_api: false
  # API key for authenticating with the development API
  dev_api_key: ""
  # The minimum level of log messages to display
  log_level: "INFO"
  
  # Performance Tuning - ML model optimization parameters
  # The model uses a normalized confidence in the range (0..1]. This threshold determines when the model's confidence is considered sufficient
  confidence_threshold: 2.0
  # Enable physics-based validation of model predictions
  physics_validation_enabled: true
  # Enable automatic seasonal learning using cosine/sine modulation
  seasonal_learning_enabled: true
  
  # Trajectory Prediction Configuration
  # Number of hours to predict in the thermal trajectory (2-8 hours)
  trajectory_steps: 4
  
  # Advanced Learning Features - Multi-lag and seasonal learning
  # Enable time-delayed learning for external heat sources (PV, fireplace, TV)
  enable_multi_lag_learning: true
  # Number of lag steps for PV effects (each step = 30 minutes)
  pv_lag_steps: 4
  # Number of lag steps for fireplace effects
  fireplace_lag_steps: 4
  # Number of lag steps for TV effects
  tv_lag_steps: 2
  # Seasonal adaptation learning rate
  seasonal_learning_rate: 0.01
  # Minimum samples before seasonal learning starts
  min_seasonal_samples: 100
  # Enable learning from HVAC-off periods (typically summer)
  enable_summer_learning: true
  
  # System Behavior Configuration - Timing and polling settings
  # Maximum minutes to wait during grace period after blocking ends
  grace_period_max_minutes: 30
  # How often (seconds) to poll blocking entities during idle period
  blocking_poll_interval_seconds: 60
  # Prediction horizon steps for calibration
  prediction_horizon_steps: 48
  
  # Shadow Mode Configuration - Testing without affecting heating control
  # When enabled, ML runs in observation mode without affecting heating
  shadow_mode: false
  # Home Assistant input_boolean to enable/disable ML control dynamically
  # When ON: ML actively controls heating, When OFF: Shadow mode (ML observes only)
  ml_heating_control_entity: "input_boolean.ml_heating"
  
  # Thermal Equilibrium Model Parameters - Physics-based model configuration
  # Core thermal properties that can be tuned for different building characteristics
  # Building thermal response time in hours (how fast building temperature changes)
  thermal_time_constant: 4.0
  # Heat loss rate per degree difference between indoor and outdoor temperature
  heat_loss_coefficient: 0.2
  # Heat pump outlet efficiency (how effectively outlet heats indoor air)
  outlet_effectiveness: 0.8
  # Outdoor temperature influence factor (how much outdoor temp affects indoor equilibrium)
  outdoor_coupling: 0.3
  # Thermal bridging losses factor (heat loss through building envelope)
  thermal_bridge_factor: 0.1
  
  # External Heat Source Weights - Only for sensors actually present in system
  # Solar heating contribution per 100W of PV power
  pv_heat_weight: 0.002
  # Fireplace heating contribution per unit time when active
  fireplace_heat_weight: 5.0
  # Electronics heating contribution per unit when TV/devices are on
  tv_heat_weight: 0.2
  
  # Adaptive Learning Parameters - Real-time parameter tuning settings
  # Base learning rate for thermal parameter adaptation
  adaptive_learning_rate: 0.01
  # Minimum allowed learning rate (prevents learning from stopping)
  min_learning_rate: 0.001
  # Maximum allowed learning rate (prevents unstable learning)
  max_learning_rate: 0.01
  # Initial confidence level for learning algorithms
  learning_confidence: 3.0
  # Number of recent prediction errors to analyze for parameter updates
  recent_errors_window: 10
  
  # Hybrid Learning Strategy (Phase 2 Enhancement) - Intelligent learning periods
  # Enable intelligent learning phase classification with weighted periods
  hybrid_learning_enabled: true
  # Enable stability classification for learning periods
  stability_classification_enabled: true
  # Weight for stable periods (high confidence learning)
  high_confidence_weight: 1.0
  # Weight for controlled transitions (low confidence learning)
  low_confidence_weight: 0.3
  # Weight for chaotic periods (skip learning)
  learning_phase_skip_weight: 0.0
  
  # MAE/RMSE Tracking System (Phase 2 Enhancement) - Prediction accuracy monitoring
  # Enable comprehensive prediction accuracy tracking
  prediction_metrics_enabled: true
  # 1 hour window (12 x 5min samples)
  metrics_window_1h: 12
  # 6 hour window (72 x 5min samples)
  metrics_window_6h: 72
  # 24 hour window (288 x 5min samples)
  metrics_window_24h: 288
  # °C threshold for accuracy classification
  prediction_accuracy_threshold: 0.3
  
  # Trajectory Prediction Enhancement (Phase 2) - Advanced trajectory prediction
  # Enable advanced trajectory prediction with forecast integration
  trajectory_prediction_enabled: true
  # Use weather forecasts in trajectory prediction
  weather_forecast_integration: true
  # Use PV forecasts in trajectory prediction
  pv_forecast_integration: true
  # Enable trajectory-based overshoot detection
  overshoot_detection_enabled: true
  
  # Historical Calibration System (Phase 0) - Physics-based optimization
  # Calibrated baseline storage file path
  calibration_baseline_file: "/data/calibrated_baseline.json"
  # °C change threshold for stability filtering
  stability_temp_change_threshold: 0.1
  # Minimum duration for stable periods (minutes)
  min_stable_period_minutes: 30
  # Scipy optimization method
  optimization_method: "L-BFGS-B"
  
  # Delta Temperature Forecast Calibration - Local weather calibration
  # Enable delta calibration using local temperature offset
  enable_delta_forecast_calibration: true
  # Maximum allowed offset (°C) for safety
  delta_calibration_max_offset: 10.0

schema:
  # Core Entity Configuration - All entity fields as string input
  target_indoor_temp_entity: "str"
  indoor_temp_entity: "str"
  outdoor_temp_entity: "str"
  heating_control_entity: "str"
  outlet_temp_entity: "str"
  target_outlet_temp_entity: "str"
  actual_target_outlet_temp_entity: "str"
  openweathermap_temp_entity: "str"
  avg_other_rooms_temp_entity: "str"
  pv_forecast_entity: "str"
  # External Heat Sources - Entity fields as string input
  pv_power_entity: "str"
  fireplace_status_entity: "str"
  tv_power_entity: "str"
  # Blocking Detection - Entity fields as string input
  dhw_status_entity: "str"
  defrost_status_entity: "str"
  disinfection_status_entity: "str"
  dhw_boost_heater_entity: "str"
  # ML Learning Parameters - Numeric types with proper ranges
  cycle_interval_minutes: "int(5,60)"
  max_temp_change_per_cycle: "float(0.5,10.0)"
  history_steps: "int(3,12)"
  history_step_minutes: "int(5,30)"
  training_lookback_hours: "int(24,720)"
  # Safety Configuration - Float types with safety ranges
  safety_max_temp: "float(18.0,30.0)"
  safety_min_temp: "float(15.0,25.0)"
  clamp_min_abs: "float(10.0,20.0)"
  clamp_max_abs: "float(50.0,80.0)"
  # InfluxDB Configuration - String and port types
  influxdb_host: "str"
  influxdb_port: "port"
  influxdb_database: "str"
  influxdb_token: "str"
  influxdb_org: "str"
  influxdb_bucket: "str"
  influx_features_bucket: "str"
  # Model Management - Boolean and integer types
  auto_backup_enabled: "bool"
  backup_retention_days: "int(1,365)"
  # Dashboard Configuration - Integer, boolean, and list types
  dashboard_update_interval: "int(5,300)"
  show_advanced_metrics: "bool"
  dashboard_theme: "list(auto|light|dark)"
  # Development Settings - Boolean, string, and list types
  enable_dev_api: "bool"
  dev_api_key: "str"
  log_level: "list(DEBUG|INFO|WARNING|ERROR)"
  # Performance Tuning - Float and boolean types
  confidence_threshold: "float(0.1,10.0)"
  physics_validation_enabled: "bool"
  seasonal_learning_enabled: "bool"
  # Trajectory Prediction - Integer type
  trajectory_steps: "int(2,8)"
  # Advanced Learning Features - Boolean, integer, and float types
  enable_multi_lag_learning: "bool"
  pv_lag_steps: "int(1,8)"
  fireplace_lag_steps: "int(1,8)"
  tv_lag_steps: "int(1,6)"
  seasonal_learning_rate: "float(0.001,0.1)"
  min_seasonal_samples: "int(50,500)"
  enable_summer_learning: "bool"
  # System Behavior Configuration - Integer types
  grace_period_max_minutes: "int(10,120)"
  blocking_poll_interval_seconds: "int(30,300)"
  prediction_horizon_steps: "int(12,96)"
  # Shadow Mode Configuration - Boolean type
  shadow_mode: "bool"
  # ML Heating Control Entity - String type
  ml_heating_control_entity: "str"
  # Thermal Equilibrium Model Parameters - Float types with physics-based ranges
  thermal_time_constant: "float(4.0,96.0)"
  heat_loss_coefficient: "float(0.005,0.25)"
  outlet_effectiveness: "float(0.01,1.5)"
  outdoor_coupling: "float(0.1,0.8)"
  thermal_bridge_factor: "float(0.01,0.5)"
  # External Heat Source Weights - Float types with reasonable ranges
  pv_heat_weight: "float(0.0001,0.01)"
  fireplace_heat_weight: "float(0.1,10.0)"
  tv_heat_weight: "float(0.01,1.0)"
  # Adaptive Learning Parameters - Float and integer types
  adaptive_learning_rate: "float(0.01,0.2)"
  min_learning_rate: "float(0.001,0.1)"
  max_learning_rate: "float(0.1,0.5)"
  learning_confidence: "float(0.1,10.0)"
  recent_errors_window: "int(5,50)"
  # Hybrid Learning Strategy (Phase 2) - Boolean and float types
  hybrid_learning_enabled: "bool"
  stability_classification_enabled: "bool"
  high_confidence_weight: "float(0.0,2.0)"
  low_confidence_weight: "float(0.0,1.0)"
  learning_phase_skip_weight: "float(0.0,1.0)"
  # MAE/RMSE Tracking System (Phase 2) - Boolean, integer, and float types
  prediction_metrics_enabled: "bool"
  metrics_window_1h: "int(6,24)"
  metrics_window_6h: "int(36,144)"
  metrics_window_24h: "int(144,576)"
  prediction_accuracy_threshold: "float(0.1,1.0)"
  # Trajectory Prediction Enhancement (Phase 2) - Boolean types
  trajectory_prediction_enabled: "bool"
  weather_forecast_integration: "bool"
  pv_forecast_integration: "bool"
  overshoot_detection_enabled: "bool"
  # Historical Calibration System (Phase 0) - String, float, integer, and list types
  calibration_baseline_file: "str"
  stability_temp_change_threshold: "float(0.05,0.5)"
  min_stable_period_minutes: "int(15,120)"
  optimization_method: "str"
  # Delta Temperature Forecast Calibration - Boolean and float types
  enable_delta_forecast_calibration: "bool"
  delta_calibration_max_offset: "float(1.0,20.0)"
